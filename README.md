# machaon/std-frontend

Система сборки стилей, скриптов и страниц для использования в Bitrix-проектах.

Поддерживает React/Vue, LESS/SASS, JavaScript/TypeScript. Сборка страниц на Nunjucks, тестирование через Jest.

Также содержит универсальные классы и функции для решения типовых задач.

Документация в процессе, несколько конкретных рецептов доступны [здесь](https://gitlab.machaon-dev.ru/machaon/std-frontend/tree/master/recipes).

Начиная новый фронтенд-проект на основе этой сборки рекомендуется удалять папку `.git` и инициализировать репозиторий заново,
чтобы не тащить в новый проект лишнюю историю коммитов. Это необходимо делать ДО выполнения npm install, т.к. в противном случае
хуки на пре-коммит будут удалены вместе со старым репозиторием.

## Использование

`npm run build`: Сборка в режиме development (без минификации, с картами исходных кодов).

`npm run watch`: То же, что и `build`, но в режиме отслеживания изменений.

`npm run dev-server`: То же, что и `watch`, но дополнительно запускает веб-сервер.

`npm run network-server`: То же, что и `watch`, но дополнительно запускает веб-сервер в локальной сети.

`npm run release`: Сборка в режиме production (минификация скриптов/стилей).

`npm test`: Прогон тестов.

`npm run lint`: Прогон линтера.

На пре-коммит хуке висят Jest и ESLint - если тесты не проходят или есть нарушение стиля, коммит не будет пропущен.

## AJAX-запросы

Для имитации запросов бэкенд используется пакет mocker-api (документация - https://github.com/jaywcjlove/mocker-api#readme).

Порт, на котором находится mock-сервер, указывается в .env, переменная MOCKER_PORT. Переменная DEV_SERVER_PORT соответствует порту, на котором будет висеть webpack-dev-server (по умолчанию 9966). Если используется webpack-dev-server, mocker-api подключается к нему как плагин на тот же хост и порт (127.0.0.1 и 9966 по умолчанию), т.е. MOCKER_PORT в рамках бэкенда будет проигнорирован.

Для корректной работы mock-сервера необходимо добавить сервис, инкапсулирующий команду запуска этого сервера (https://wiki.machaon-dev.ru/ru/devs/devops/systemdify), создать виртуальный хост и проксировать трафик с него на указанный в команде сервиса порт mock-сервера (https://wiki.machaon-dev.ru/devs/devops/nginx/proxy).

Запросы и ответы обрабатываются в /mocker/index.js.

Axios необходимо импортировать из "@main/axios" (создан экземпляр с заголовками по умолчанию и функционалом подмены порта через перехватчик запросов).

В данный момент перехватчик заменяет порт в любом случае, поэтому кейс, когда JS через CORS осознанно обращается на другой порт, не сработает.

Роуты прописываются в файле /routes.js. Для перекрытия роутов в рамках площадки можно использовать файл /routes.local.js, исключенный из репозитория.

## JustFile
Для выполнения команд используется just.
Инструкция по установке just под любую ОС - https://github.com/casey/just.

## Как внести свой вклад

    git clone git@gitlab.machaon-dev.ru:machaon/std-frontend.git
    cd std-frontend

Все изменения делаются в отдельной ветке, по возможности пишутся тесты.
Далее - Merge request в Gitlab. Все тесты должны проходить.
